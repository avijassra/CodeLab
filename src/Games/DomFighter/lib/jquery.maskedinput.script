(function(d){var e=(d.browser.msie?"paste":"input")+".mask",f=window.orientation!=undefined;d.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},dataName:"rawMaskFn"},d.fn.extend({caret:function(g,h){if(this.length!=0){if(typeof g=="number"){h=typeof h=="number"?h:g;return this.each(function(){if(this.setSelectionRange){this.setSelectionRange(g,h)}else{if(this.createTextRange){var a=this.createTextRange();a.collapse(!0),a.moveEnd("character",h),a.moveStart("character",g),a.select()}}})}if(this[0].setSelectionRange){g=this[0].selectionStart,h=this[0].selectionEnd}else{if(document.selection&&document.selection.createRange){var i=document.selection.createRange();g=0-i.duplicate().moveStart("character",-100000),h=g+i.text.length}}return{begin:g,end:h}}},unmask:function(){return this.trigger("unmask")},mask:function(a,b){if(!a&&this.length>0){var c=d(this[0]);return c.data(d.mask.dataName)()}b=d.extend({placeholder:"_",completed:null},b);var l=d.mask.definitions,m=[],n=a.length,o=null,p=a.length;d.each(a.split(""),function(g,h){h=="?"?(p--,n=g):l[h]?(m.push(new RegExp(l[h])),o==null&&(o=m.length-1)):m.push(null)});return this.trigger("unmask").each(function(){function C(q){var r=g.val(),s=-1;for(var t=0,u=0;t<p;t++){if(m[t]){h[t]=b.placeholder;while(u++<r.length){var v=r.charAt(u-1);if(m[t].test(v)){h[t]=v,s=t;break}}if(u>r.length){break}}else{h[t]==r.charAt(u)&&t!=n&&(u++,s=t)}}if(!q&&s+1<n){g.val(""),A(0,p)}else{if(q||s+1>=n){B(),q||g.val(g.val().substring(0,s+1))}}return n?t:o}function B(){return g.val(h.join("")).val()}function A(q,r){for(var s=q;s<r&&s<p;s++){m[s]&&(h[s]=b.placeholder)}}function z(q){var r=q.which,s=g.caret();if(q.ctrlKey||q.altKey||q.metaKey||r<32){return !0}if(r){s.end-s.begin!=0&&(A(s.begin,s.end),w(s.begin,s.end-1));var t=j(s.begin-1);if(t<p){var u=String.fromCharCode(r);if(m[t].test(u)){x(t),h[t]=u,B();var v=j(t);g.caret(v),b.completed&&v>=p&&b.completed.call(g)}}return !1}}function y(q){var r=q.which;if(r==8||r==46||f&&r==127){var s=g.caret(),t=s.begin,u=s.end;u-t==0&&(t=r!=46?k(t):u=j(t-1),u=r==46?j(u):u),A(t,u),w(t,u-1);return !1}if(r==27){g.val(i),g.caret(0,C());return !1}}function x(q){for(var r=q,s=b.placeholder;r<p;r++){if(m[r]){var t=j(r),u=h[r];h[r]=s;if(t<p&&m[t].test(u)){s=u}else{break}}}}function w(q,r){if(!(q<0)){for(var s=q,t=j(r);s<p;s++){if(m[s]){if(t<p&&m[s].test(h[t])){h[s]=h[t],h[t]=b.placeholder}else{break}t=j(t)}}B(),g.caret(Math.max(o,q))}}function k(q){while(--q>=0&&!m[q]){}return q}function j(q){while(++q<=p&&!m[q]){}return q}var g=d(this),h=d.map(a.split(""),function(q,r){if(q!="?"){return l[q]?b.placeholder:q}}),i=g.val();g.data(d.mask.dataName,function(){return d.map(h,function(q,r){return m[r]&&q!=b.placeholder?q:null}).join("")}),g.attr("readonly")||g.one("unmask",function(){g.unbind(".mask").removeData(d.mask.dataName)}).bind("focus.mask",function(){i=g.val();var q=C();B();var r=function(){q==a.length?g.caret(0,q):g.caret(q)};(d.browser.msie?r:function(){setTimeout(r,0)})()}).bind("blur.mask",function(){C(),g.val()!=i&&g.change()}).bind("keydown.mask",y).bind("keypress.mask",z).bind(e,function(){setTimeout(function(){g.caret(C(!0))},0)}),C()})}})})(jQuery);